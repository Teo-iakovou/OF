(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[326],{5531:function(e,t,n){"use strict";n.d(t,{Z:function(){return createLucideIcon}});var a=n(2265);/**
 * @license lucide-react v0.515.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let toKebabCase=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),toCamelCase=e=>e.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,t,n)=>n?n.toUpperCase():t.toLowerCase()),toPascalCase=e=>{let t=toCamelCase(e);return t.charAt(0).toUpperCase()+t.slice(1)},mergeClasses=(...e)=>e.filter((e,t,n)=>!!e&&""!==e.trim()&&n.indexOf(e)===t).join(" ").trim(),hasA11yProp=e=>{for(let t in e)if(t.startsWith("aria-")||"role"===t||"title"===t)return!0};/**
 * @license lucide-react v0.515.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var r={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.515.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let o=(0,a.forwardRef)(({color:e="currentColor",size:t=24,strokeWidth:n=2,absoluteStrokeWidth:o,className:i="",children:s,iconNode:c,...l},u)=>(0,a.createElement)("svg",{ref:u,...r,width:t,height:t,stroke:e,strokeWidth:o?24*Number(n)/Number(t):n,className:mergeClasses("lucide",i),...!s&&!hasA11yProp(l)&&{"aria-hidden":"true"},...l},[...c.map(([e,t])=>(0,a.createElement)(e,t)),...Array.isArray(s)?s:[s]])),createLucideIcon=(e,t)=>{let n=(0,a.forwardRef)(({className:n,...r},i)=>(0,a.createElement)(o,{ref:i,iconNode:t,className:mergeClasses(`lucide-${toKebabCase(toPascalCase(e))}`,`lucide-${e}`,n),...r}));return n.displayName=toPascalCase(e),n}},9865:function(e,t,n){"use strict";n.d(t,{Z:function(){return r}});var a=n(5531);let r=(0,a.Z)("book-open",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]])},2601:function(e,t,n){"use strict";var a,r;e.exports=(null==(a=n.g.process)?void 0:a.env)&&"object"==typeof(null==(r=n.g.process)?void 0:r.env)?n.g.process:n(8960)},1321:function(e,t,n){Promise.resolve().then(n.bind(n,3254))},5817:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return CoachChatHistory}});var a=n(7437),r=n(2265),o=n(6354),i=n(9865),s=n(1243),c=n(2601);let l="1"===c.env.NEXT_PUBLIC_DEBUG||new URLSearchParams(window.location.search).has("debug");function dbg(e,t){if(l)try{console.groupCollapsed("[DBG] ".concat(e)),void 0!==t&&console.log(t),console.groupEnd()}catch(n){console.log("[DBG] ".concat(e),t)}}var u=n(4278);function CoachChatHistory(e){let{onSelect:t,selectedId:n,refreshKey:c,showHeader:l=!1,onNew:d,className:h,maxHeight:f=420}=e,[p,m]=(0,r.useState)([]),[y,v]=(0,r.useState)(!0);return(0,r.useEffect)(()=>{v(!0),dbg("history:load:start",{refreshKey:c}),(0,o.ku)().then(e=>{dbg("history:load:success",{count:e.length,titles:e.map(e=>e.title).slice(0,5)}),m(e)}).catch(e=>dbg("history:load:error",e)).finally(()=>v(!1))},[c]),(0,a.jsxs)("div",{className:["w-full bg-[#0f1520] border border-[#232B36] rounded-2xl shadow-2xl overflow-hidden",h||""].join(" "),style:{maxHeight:f},children:[l&&(0,a.jsxs)("div",{className:"flex items-center justify-between px-4 pt-3 pb-2 border-b border-[#232B36] bg-[#121A24]",children:[(0,a.jsxs)("span",{className:"font-semibold text-gray-200 text-sm inline-flex items-center gap-2",children:[(0,a.jsx)(i.Z,{className:"w-4 h-4 text-cyan-400"}),"AI Chat History"]}),!!d&&(0,a.jsx)("button",{onClick:d,className:"px-2 py-1 text-xs rounded text-white bg-cyan-600 hover:bg-cyan-700 transition",children:"+ New"})]}),(0,a.jsx)("div",{className:"p-3 md:p-4 space-y-2 overflow-y-auto",style:{maxHeight:"number"==typeof f?f:void 0},children:y?(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(u.O,{className:"h-10 w-full"}),(0,a.jsx)(u.O,{className:"h-10 w-full"}),(0,a.jsx)(u.O,{className:"h-10 w-full"}),(0,a.jsx)(u.O,{className:"h-10 w-3/4"})]}):0===p.length?(0,a.jsx)("div",{className:"text-xs text-gray-400",children:"No conversations yet."}):p.map(e=>{let r=n===e._id;return(0,a.jsxs)("button",{onClick:()=>t(e._id),className:["w-full text-left px-3 py-2 rounded-xl transition border",r?"bg-cyan-600/15 border-cyan-600/40 text-cyan-100 ring-1 ring-cyan-500/30":"bg-[#141a26]/70 hover:bg-[#17202d] border-[#232B36] text-gray-200"].join(" "),children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(i.Z,{className:"w-4 h-4 ".concat(r?"text-cyan-400":"text-gray-400")}),(0,a.jsx)("span",{className:"font-medium truncate",children:e.title||"Untitled"}),(0,a.jsx)("span",{className:"ml-auto",children:(0,a.jsx)("button",{type:"button",onClick:async t=>{t.stopPropagation();try{let t=await (0,o.TD)(e.title||"Conversation"),n=new Audio(t);n.play()}catch(e){}},className:"inline-flex items-center text-xs text-gray-300 hover:text-white","aria-label":"Play title",children:(0,a.jsx)(s.Z,{className:"w-4 h-4"})})})]}),(0,a.jsx)("div",{className:"mt-1 text-[11px] text-gray-400",children:function(e){if(!e)return"";try{let t=new Date(e);return t.toLocaleString(void 0,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch(e){return""}}(e.updatedAt)})]},e._id)})})]})}},3254:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return AiCoachChatPage}});var a=n(7437),r=n(2265),o=n(6354),i=n(9865),s=n(9445),c=n(5817);function AiCoachChatPage(){let[e,t]=(0,r.useState)(!1),n=(0,r.useRef)(null),[l,u]=(0,r.useState)(),[d,h]=(0,r.useState)(0);async function handleNewChat(){let e=await (0,o.BT)();e?(u(e),h(e=>e+1)):(u(void 0),h(e=>e+1)),t(!1)}return(0,r.useEffect)(()=>{if(e)return document.addEventListener("mousedown",handle),()=>document.removeEventListener("mousedown",handle);function handle(e){n.current&&!n.current.contains(e.target)&&t(!1)}},[e]),(0,a.jsxs)("div",{className:"min-h-screen flex flex-col text-white",children:[(0,a.jsx)("header",{className:"sticky top-0 z-40 shrink-0 pt-4 md:pt-12 pl-16 pr-4 md:px-12 lg:px-20 max-w-6xl mx-auto w-full bg-transparent",children:(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h1",{className:"text-3xl md:text-4xl font-semibold tracking-tight",children:"AI Chat"}),(0,a.jsxs)("button",{className:"px-4 py-2 rounded bg-gray-900 hover:bg-gray-800 text-gray-100 hover:text-cyan-400 transition flex items-center gap-2",onClick:()=>t(e=>!e),children:[(0,a.jsx)("span",{className:"hidden md:inline font-medium",children:"Chat History"}),(0,a.jsx)(i.Z,{className:"w-5 h-5 md:hidden"})]})]}),e&&(0,a.jsx)("div",{ref:n,className:"absolute right-0 mt-2 z-50 w-[340px]",children:(0,a.jsx)(c.default,{onSelect:function(e){u(e),t(!1)},selectedId:l,refreshKey:d,showHeader:!0,onNew:handleNewChat,maxHeight:420})})]})}),(0,a.jsx)("main",{className:"flex-1 min-h-0 w-full",children:(0,a.jsx)("div",{className:"w-full max-w-3xl mx-auto px-2 md:px-0 flex flex-col min-h-0",children:(0,a.jsx)("div",{className:"flex-1 min-h-0 flex flex-col",children:(0,a.jsx)(s.default,{initialConversationId:l,onNewConversation:function(e){u(e),h(e=>e+1)},layout:"page"})})})})]})}},6354:function(e,t,n){"use strict";n.d(t,{BT:function(){return createEmptyConversation},Do:function(){return purchasePackage},Ii:function(){return deleteAnalysisResult},Kc:function(){return coachChat},Nn:function(){return checkUserPackage},TD:function(){return ttsSynthesize},Um:function(){return fetchConversation},Vv:function(){return startCheckout},fA:function(){return sendFeedback},ku:function(){return fetchConversations},lG:function(){return fetchCoachChatPrompts},mF:function(){return analyzeImageMultipart},mI:function(){return fetchAnalysisHistory},sm:function(){return clearApiCaches},uh:function(){return generateConversationTitle}});var a=n(2205),r=n(2601);async function readJsonOrText(e){let t=await e.text();try{return{ok:e.ok,status:e.status,data:JSON.parse(t)}}catch(n){return{ok:e.ok,status:e.status,data:t}}}function ensureOk(e,t){if(!e.ok){let n="string"==typeof e.data?e.data:JSON.stringify(e.data,null,2);throw Error("".concat(t," failed (").concat(e.status,") - ").concat(n))}return e.data}async function fetchAnalysisHistory(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,n="".concat(a._,"/api/analyze?page=").concat(e,"&limit=").concat(t,"&ts=").concat(Date.now()),r=await (0,a.r)(n,{method:"GET",cache:"no-store"});if(!r.ok)throw Error("Fetch analysis history failed");return r.data}async function deleteAnalysisResult(e){let t=await fetch("".concat(a._,"/api/analyze/").concat(e),{method:"DELETE",headers:{"Content-Type":"application/json"}}),n=await readJsonOrText(t);return ensureOk(n,"Delete analysis result")}async function startCheckout(e){let t="true"===r.env.NEXT_PUBLIC_USE_BFF,n=t?"/api/checkout/create-checkout-session":"".concat(a._,"/api/checkout/create-checkout-session"),o=await fetch(n,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({packageId:e})}),{ok:i,data:s}=await readJsonOrText(o);if(!i)throw Error("string"==typeof s?s:(null==s?void 0:s.error)||"Failed to start checkout");if(!(null==s?void 0:s.url))throw Error("No checkout URL returned");window.location.href=s.url}async function purchasePackage(e){let t="true"===r.env.NEXT_PUBLIC_USE_BFF,n=t?"/api/user/purchase":"".concat(a._,"/api/user/purchase"),o=await fetch(n,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({packageId:e})}),i=await readJsonOrText(o);return ensureOk(i,"Purchase package")}async function checkUserPackage(){let e=Date.now();return void 0!==o.value&&e-o.ts<5e3?o.value:(o.inFlight||(o.inFlight=(async()=>{try{let e=await (0,a.r)("".concat(a._,"/api/user/check-package"),{method:"GET",cache:"no-store"});if(!e.ok)throw Error("Check user package failed");let t=e.data;return o.value=t,o.ts=Date.now(),t}catch(e){if("object"==typeof e&&null!==e&&("number"==typeof e.status&&401===e.status||"string"==typeof e.message&&"Unauthorized"===e.message))return{hasAccess:!1};throw e}finally{o.inFlight=null}})()),o.inFlight)}let o={value:void 0,ts:0,inFlight:null};function clearApiCaches(){o.value=void 0,o.ts=0,o.inFlight=null}async function coachChat(e){let{question:t,latestContentInfo:n,conversationId:r,title:o}=e;try{let e=await fetch("".concat(a._,"/api/coach-chat"),{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({question:t,latestContentInfo:n,conversationId:r,title:o})}),i=await readJsonOrText(e);if(200===e.status)return{status:200,data:i.data};if(402===e.status)return{status:402,data:i.data};if(429===e.status)return{status:429,data:i.data};return{status:e.status,data:i.data}}catch(e){return{status:0,data:{error:"Network error"}}}}async function fetchConversation(e){let t=await fetch("".concat(a._,"/api/conversations/").concat(e),{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include",cache:"no-store"}),n=await readJsonOrText(t);return ensureOk(n,"Fetch conversation")}async function createEmptyConversation(){try{var e,t;let n=await fetch("".concat(a._,"/api/conversations"),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({})}),r=await readJsonOrText(n),o=ensureOk(r,"Create conversation");return null!==(t=null!==(e=o._id)&&void 0!==e?e:o.id)&&void 0!==t?t:null}catch(e){return console.error("Error creating new conversation:",e),null}}async function generateConversationTitle(e,t){let n=await fetch("".concat(a._,"/api/conversations/").concat(e,"/generate-title"),{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({firstUserMessage:t}),cache:"no-store"}),r=await readJsonOrText(n),o=ensureOk(r,"Generate title");return o.title||null}async function fetchConversations(){let e="".concat(a._,"/api/conversations?ts=").concat(Date.now()),t=await (0,a.r)(e,{method:"GET",cache:"no-store"});if(!t.ok)throw Error("Fetch conversations failed");return t.data}async function sendFeedback(e){let t=await fetch("".concat(a._,"/api/feedback"),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e})}),n=await readJsonOrText(t);if(!n.ok){var r;throw Error("string"==typeof n.data?n.data:(null===(r=n.data)||void 0===r?void 0:r.error)||"Failed to send feedback (".concat(n.status,")"))}return n.data}function analyzeImageMultipart(e){let{file:t,goal:n,linkBase:r,onProgress:o,captions:i=!0,signal:s}=e,c=new FormData;c.append("image",t),n&&c.append("goal",n),r&&c.append("linkBase",r);try{let e=Intl.DateTimeFormat().resolvedOptions().timeZone;e&&c.append("timezone",e)}catch(e){}let l="".concat(a._,"/api/analyze")+(!1===i?"?captions=false":"");return new Promise((e,t)=>{let n=new XMLHttpRequest;n.open("POST",l,!0),n.withCredentials=!0,n.onreadystatechange=()=>{if(4===n.readyState){if(n.status>=200&&n.status<300)try{let t=JSON.parse(n.responseText);e(t)}catch(e){t(Error("Invalid JSON from server."))}else try{let e=JSON.parse(n.responseText);t(Error((null==e?void 0:e.error)||"Upload failed (".concat(n.status,")")))}catch(e){t(Error("Upload failed (".concat(n.status,")")))}}},n.upload&&"function"==typeof o&&(n.upload.onprogress=e=>{e.lengthComputable&&o(Math.round(e.loaded/e.total*100))}),n.onerror=()=>t(Error("Network error"));let a=!1,onAbort=()=>{a=!0;try{n.abort()}catch(e){}t(new DOMException("Aborted","AbortError"))};if(s){if(s.aborted)return onAbort();s.addEventListener("abort",onAbort,{once:!0})}n.send(c);let cleanup=()=>{s&&s.removeEventListener("abort",onAbort)};n.onloadend=()=>{a||cleanup()}})}async function fetchCoachChatPrompts(){let e="".concat(a._,"/api/coach-chat/prompts?ts=").concat(Date.now()),t=await (0,a.r)(e,{method:"GET",cache:"no-store"});if(!t.ok)throw Error("Fetch coach prompts failed");return t.data}async function ttsSynthesize(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=new URLSearchParams({text:e});return t.voiceId&&n.set("voiceId",t.voiceId),t.format&&n.set("format",t.format),n.set("ts",String(Date.now())),"".concat(a._,"/api/tts?").concat(n.toString())}},2205:function(e,t,n){"use strict";n.d(t,{_:function(){return r},r:function(){return fetchJson}});var a=n(2601);let r=a.env.NEXT_PUBLIC_API_URL||"http://localhost:5001";async function fetchJson(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n="true"===a.env.NEXT_PUBLIC_USE_BFF,o=e;try{if(n&&"string"==typeof e)for(let t of["/api/auth/","/api/checkout/","/api/user/"]){if(e.startsWith(r+t)){o=e.slice(r.length);break}let n=e.indexOf(t);if(e.startsWith("http")&&-1!==n){o=e.slice(n);break}}}catch(e){}let i="true"===a.env.NEXT_PUBLIC_HEADER_AUTH,s=new Headers(t.headers);s.has("content-type")||s.set("Content-Type","application/json");try{if(i){var c;let e=null===(c=window.localStorage)||void 0===c?void 0:c.getItem("ai_token");e&&!s.has("authorization")&&s.set("Authorization","Bearer ".concat(e))}}catch(e){}let l=await fetch(o,{...t,credentials:"include",headers:s}),u=await l.text(),d=null;try{d=u?JSON.parse(u):null}catch(e){d=u}if(401===l.status){let e=Error("Unauthorized");throw e.status=401,e.data=d,e}return{ok:l.ok,status:l.status,data:d}}},8960:function(e){!function(){var t={229:function(e){var t,n,a,r=e.exports={};function defaultSetTimout(){throw Error("setTimeout has not been defined")}function defaultClearTimeout(){throw Error("clearTimeout has not been defined")}function runTimeout(e){if(t===setTimeout)return setTimeout(e,0);if((t===defaultSetTimout||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(n){try{return t.call(null,e,0)}catch(n){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){t=defaultSetTimout}try{n="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){n=defaultClearTimeout}}();var o=[],i=!1,s=-1;function cleanUpNextTick(){i&&a&&(i=!1,a.length?o=a.concat(o):s=-1,o.length&&drainQueue())}function drainQueue(){if(!i){var e=runTimeout(cleanUpNextTick);i=!0;for(var t=o.length;t;){for(a=o,o=[];++s<t;)a&&a[s].run();s=-1,t=o.length}a=null,i=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===defaultClearTimeout||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function Item(e,t){this.fun=e,this.array=t}function noop(){}r.nextTick=function(e){var t=Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];o.push(new Item(e,t)),1!==o.length||i||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=noop,r.addListener=noop,r.once=noop,r.off=noop,r.removeListener=noop,r.removeAllListeners=noop,r.emit=noop,r.prependListener=noop,r.prependOnceListener=noop,r.listeners=function(e){return[]},r.binding=function(e){throw Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw Error("process.chdir is not supported")},r.umask=function(){return 0}}},n={};function __nccwpck_require__(e){var a=n[e];if(void 0!==a)return a.exports;var r=n[e]={exports:{}},o=!0;try{t[e](r,r.exports,__nccwpck_require__),o=!1}finally{o&&delete n[e]}return r.exports}__nccwpck_require__.ab="//";var a=__nccwpck_require__(229);e.exports=a}()},622:function(e,t,n){"use strict";/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var a=n(2265),r=Symbol.for("react.element"),o=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,s=a.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function q(e,t,n){var a,o={},l=null,u=null;for(a in void 0!==n&&(l=""+n),void 0!==t.key&&(l=""+t.key),void 0!==t.ref&&(u=t.ref),t)i.call(t,a)&&!c.hasOwnProperty(a)&&(o[a]=t[a]);if(e&&e.defaultProps)for(a in t=e.defaultProps)void 0===o[a]&&(o[a]=t[a]);return{$$typeof:r,type:e,key:l,ref:u,props:o,_owner:s.current}}t.Fragment=o,t.jsx=q,t.jsxs=q},7437:function(e,t,n){"use strict";e.exports=n(622)}},function(e){e.O(0,[445,971,472,744],function(){return e(e.s=1321)}),_N_E=e.O()}]);