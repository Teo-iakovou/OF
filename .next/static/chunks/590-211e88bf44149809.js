"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[590],{388:function(t,e,a){let n;a.d(e,{U:function(){return clearUserCache},a:function(){return useUser}});var r=a(2265),o=a(2205),c=a(4033);let i=null,s=0;async function fetchUserOnce(){return i||(i=(async()=>{try{let t=await (0,o.r)("".concat(o._,"/api/auth/me"),{method:"GET",cache:"no-store"});n=t.ok?t.data:null}catch(t){n=null}finally{s=Date.now();let t=null!=n?n:null;return i=null,t}})())}function useUser(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{redirectTo:e="/login",required:a=!0,initialUser:o}=t,[i,l]=(0,r.useState)(null),[u,d]=(0,r.useState)(!0),[h,f]=(0,r.useState)(null),p=(0,c.useRouter)();return(0,r.useEffect)(()=>{let t=!1;return(async()=>{try{if(void 0!==o){var r,c;let t=!!(null===(c=window.localStorage)||void 0===c?void 0:null===(r=c.getItem)||void 0===r?void 0:r.call(c,"ai_token"));if(o){n=o,s=Date.now(),l(o),d(!1);return}if(!o&&a&&!t){p.replace(e),l(null),d(!1);return}}let i=Date.now(),u=void 0!==n&&i-s<5e3;if(u&&!a){l(null!=n?n:null),d(!1);return}let h=await fetchUserOnce();if(t)return;l(h),!h&&a&&p.replace(e)}catch(n){if(t)return;f(n),l(null),a&&p.replace(e)}finally{t||d(!1)}})(),()=>{t=!0}},[e,a,p,o]),{user:i,loading:u,error:h,refresh:async()=>{d(!0);try{let t=await fetchUserOnce();l(t)}catch(t){l(null),f(t)}finally{d(!1)}}}}function clearUserCache(){n=void 0,i=null,s=0}},6354:function(t,e,a){a.d(e,{BT:function(){return createEmptyConversation},Do:function(){return purchasePackage},Ii:function(){return deleteAnalysisResult},Kc:function(){return coachChat},Nn:function(){return checkUserPackage},TD:function(){return ttsSynthesize},Um:function(){return fetchConversation},Vv:function(){return startCheckout},fA:function(){return sendFeedback},ku:function(){return fetchConversations},lG:function(){return fetchCoachChatPrompts},mF:function(){return analyzeImageMultipart},mI:function(){return fetchAnalysisHistory},sm:function(){return clearApiCaches},uh:function(){return generateConversationTitle}});var n=a(2205),r=a(2601);async function readJsonOrText(t){let e=await t.text();try{return{ok:t.ok,status:t.status,data:JSON.parse(e)}}catch(a){return{ok:t.ok,status:t.status,data:e}}}function ensureOk(t,e){if(!t.ok){let a="string"==typeof t.data?t.data:JSON.stringify(t.data,null,2);throw Error("".concat(e," failed (").concat(t.status,") - ").concat(a))}return t.data}async function fetchAnalysisHistory(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,a="".concat(n._,"/api/analyze?page=").concat(t,"&limit=").concat(e,"&ts=").concat(Date.now()),r=await (0,n.r)(a,{method:"GET",cache:"no-store"});if(!r.ok)throw Error("Fetch analysis history failed");return r.data}async function deleteAnalysisResult(t){let e=await fetch("".concat(n._,"/api/analyze/").concat(t),{method:"DELETE",headers:{"Content-Type":"application/json"}}),a=await readJsonOrText(e);return ensureOk(a,"Delete analysis result")}async function startCheckout(t){let e="true"===r.env.NEXT_PUBLIC_USE_BFF,a=e?"/api/checkout/create-checkout-session":"".concat(n._,"/api/checkout/create-checkout-session"),o=await fetch(a,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({packageId:t})}),{ok:c,data:i}=await readJsonOrText(o);if(!c)throw Error("string"==typeof i?i:(null==i?void 0:i.error)||"Failed to start checkout");if(!(null==i?void 0:i.url))throw Error("No checkout URL returned");window.location.href=i.url}async function purchasePackage(t){let e="true"===r.env.NEXT_PUBLIC_USE_BFF,a=e?"/api/user/purchase":"".concat(n._,"/api/user/purchase"),o=await fetch(a,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({packageId:t})}),c=await readJsonOrText(o);return ensureOk(c,"Purchase package")}async function checkUserPackage(){let t=Date.now();return void 0!==o.value&&t-o.ts<5e3?o.value:(o.inFlight||(o.inFlight=(async()=>{try{let t=await (0,n.r)("".concat(n._,"/api/user/check-package"),{method:"GET",cache:"no-store"});if(!t.ok)throw Error("Check user package failed");let e=t.data;return o.value=e,o.ts=Date.now(),e}catch(t){if("object"==typeof t&&null!==t&&("number"==typeof t.status&&401===t.status||"string"==typeof t.message&&"Unauthorized"===t.message))return{hasAccess:!1};throw t}finally{o.inFlight=null}})()),o.inFlight)}let o={value:void 0,ts:0,inFlight:null};function clearApiCaches(){o.value=void 0,o.ts=0,o.inFlight=null}async function coachChat(t){let{question:e,latestContentInfo:a,conversationId:r,title:o}=t;try{let t=await fetch("".concat(n._,"/api/coach-chat"),{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({question:e,latestContentInfo:a,conversationId:r,title:o})}),c=await readJsonOrText(t);if(200===t.status)return{status:200,data:c.data};if(402===t.status)return{status:402,data:c.data};if(429===t.status)return{status:429,data:c.data};return{status:t.status,data:c.data}}catch(t){return{status:0,data:{error:"Network error"}}}}async function fetchConversation(t){let e=await fetch("".concat(n._,"/api/conversations/").concat(t),{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include",cache:"no-store"}),a=await readJsonOrText(e);return ensureOk(a,"Fetch conversation")}async function createEmptyConversation(){try{var t,e;let a=await fetch("".concat(n._,"/api/conversations"),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({})}),r=await readJsonOrText(a),o=ensureOk(r,"Create conversation");return null!==(e=null!==(t=o._id)&&void 0!==t?t:o.id)&&void 0!==e?e:null}catch(t){return console.error("Error creating new conversation:",t),null}}async function generateConversationTitle(t,e){let a=await fetch("".concat(n._,"/api/conversations/").concat(t,"/generate-title"),{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({firstUserMessage:e}),cache:"no-store"}),r=await readJsonOrText(a),o=ensureOk(r,"Generate title");return o.title||null}async function fetchConversations(){let t="".concat(n._,"/api/conversations?ts=").concat(Date.now()),e=await (0,n.r)(t,{method:"GET",cache:"no-store"});if(!e.ok)throw Error("Fetch conversations failed");return e.data}async function sendFeedback(t){let e=await fetch("".concat(n._,"/api/feedback"),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t})}),a=await readJsonOrText(e);if(!a.ok){var r;throw Error("string"==typeof a.data?a.data:(null===(r=a.data)||void 0===r?void 0:r.error)||"Failed to send feedback (".concat(a.status,")"))}return a.data}function analyzeImageMultipart(t){let{file:e,goal:a,linkBase:r,onProgress:o,captions:c=!0,signal:i}=t,s=new FormData;s.append("image",e),a&&s.append("goal",a),r&&s.append("linkBase",r);try{let t=Intl.DateTimeFormat().resolvedOptions().timeZone;t&&s.append("timezone",t)}catch(t){}let l="".concat(n._,"/api/analyze")+(!1===c?"?captions=false":"");return new Promise((t,e)=>{let a=new XMLHttpRequest;a.open("POST",l,!0),a.withCredentials=!0,a.onreadystatechange=()=>{if(4===a.readyState){if(a.status>=200&&a.status<300)try{let e=JSON.parse(a.responseText);t(e)}catch(t){e(Error("Invalid JSON from server."))}else try{let t=JSON.parse(a.responseText);e(Error((null==t?void 0:t.error)||"Upload failed (".concat(a.status,")")))}catch(t){e(Error("Upload failed (".concat(a.status,")")))}}},a.upload&&"function"==typeof o&&(a.upload.onprogress=t=>{t.lengthComputable&&o(Math.round(t.loaded/t.total*100))}),a.onerror=()=>e(Error("Network error"));let n=!1,onAbort=()=>{n=!0;try{a.abort()}catch(t){}e(new DOMException("Aborted","AbortError"))};if(i){if(i.aborted)return onAbort();i.addEventListener("abort",onAbort,{once:!0})}a.send(s);let cleanup=()=>{i&&i.removeEventListener("abort",onAbort)};a.onloadend=()=>{n||cleanup()}})}async function fetchCoachChatPrompts(){let t="".concat(n._,"/api/coach-chat/prompts?ts=").concat(Date.now()),e=await (0,n.r)(t,{method:"GET",cache:"no-store"});if(!e.ok)throw Error("Fetch coach prompts failed");return e.data}async function ttsSynthesize(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=new URLSearchParams({text:t});return e.voiceId&&a.set("voiceId",e.voiceId),e.format&&a.set("format",e.format),a.set("ts",String(Date.now())),"".concat(n._,"/api/tts?").concat(a.toString())}},2205:function(t,e,a){a.d(e,{_:function(){return r},r:function(){return fetchJson}});var n=a(2601);let r=n.env.NEXT_PUBLIC_API_URL||"http://localhost:5001";async function fetchJson(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a="true"===n.env.NEXT_PUBLIC_USE_BFF,o=t;try{if(a&&"string"==typeof t)for(let e of["/api/auth/","/api/checkout/","/api/user/"]){if(t.startsWith(r+e)){o=t.slice(r.length);break}let a=t.indexOf(e);if(t.startsWith("http")&&-1!==a){o=t.slice(a);break}}}catch(t){}let c="true"===n.env.NEXT_PUBLIC_HEADER_AUTH,i=new Headers(e.headers);i.has("content-type")||i.set("Content-Type","application/json");try{if(c){var s;let t=null===(s=window.localStorage)||void 0===s?void 0:s.getItem("ai_token");t&&!i.has("authorization")&&i.set("Authorization","Bearer ".concat(t))}}catch(t){}let l=await fetch(o,{...e,credentials:"include",headers:i}),u=await l.text(),d=null;try{d=u?JSON.parse(u):null}catch(t){d=u}if(401===l.status){let t=Error("Unauthorized");throw t.status=401,t.data=d,t}return{ok:l.ok,status:l.status,data:d}}}}]);