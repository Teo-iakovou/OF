"use strict";(()=>{var e={};e.id=4208,e.ids=[4208],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},9523:e=>{e.exports=require("dns")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},98188:e=>{e.exports=require("module")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},12781:e=>{e.exports=require("stream")},71576:e=>{e.exports=require("string_decoder")},24404:e=>{e.exports=require("tls")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},71267:e=>{e.exports=require("worker_threads")},78250:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>m,originalPathname:()=>h,requestAsyncStorage:()=>c,routeModule:()=>d,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>y});var i={};t.r(i),t.d(i,{POST:()=>POST,dynamic:()=>p,runtime:()=>l}),t(78976);var a=t(10884),o=t(16132),n=t(14300),s=t(95798),u=t(78657);let l="nodejs",p="force-dynamic";function sanitizeString(e){if("string"!=typeof e)return;let r=e.trim();return r||void 0}function parseFloatInRange(e,r,t){let i="number"==typeof e?e:"string"==typeof e?Number(e):NaN;if(Number.isFinite(i))return Math.min(t,Math.max(r,i))}function parseInteger(e){let r="number"==typeof e?e:"string"==typeof e?Number(e):NaN;if(Number.isInteger(r))return r}function parseBoolean(e,r=!1){if("boolean"==typeof e)return e;if("string"==typeof e){let r=e.trim().toLowerCase();if(["true","1","yes","y","on"].includes(r))return!0;if(["false","0","no","n","off"].includes(r))return!1}return r}function parseIntList(e){if(e){if(Array.isArray(e)){let r=e.map(e=>Number(e)).filter(e=>Number.isFinite(e));return r.length?r:void 0}if("string"==typeof e){let r=e.split(",").map(e=>Number(e.trim())).filter(e=>Number.isFinite(e));return r.length?r:void 0}}}async function fileToPayload(e){if(!e)return;let r=await e.arrayBuffer(),t=n.Buffer.from(r);return{filename:e.name||"upload.bin",contentType:e.type||"application/octet-stream",data:t.toString("base64"),size:t.length}}function validateUrl(e){if("string"!=typeof e||!e.trim())throw Error("must be a non-empty string");let r=e.trim();try{let e=new URL(r);if(!["http:","https:"].includes(e.protocol))throw Error("unsupported protocol")}catch(e){throw Error(`invalid URL (${e.message})`)}return r}async function handleJsonPayload(e){let r,t;if(!e||"object"!=typeof e)return{error:s.Z.json({error:"Invalid JSON body"},{status:400})};let{imageUrl:i,audioUrl:a,userId:o,webhookUrl:n,metadata:u,options:l}=e;if(!o||"string"!=typeof o)return{error:s.Z.json({error:"userId is required"},{status:400})};try{r=validateUrl(i),t=validateUrl(a)}catch(e){return{error:s.Z.json({error:`Invalid input: ${e.message}`},{status:400})}}let p=null;if(n)try{p=validateUrl(n)}catch(e){return{error:s.Z.json({error:`Invalid webhookUrl: ${e.message}`},{status:400})}}if(!r.toLowerCase().match(/\.(png|jpg|jpeg)$/))return{error:s.Z.json({error:"imageUrl must point to a .png or .jpg file"},{status:400})};if(!t.toLowerCase().match(/\.(mp3|wav)$/))return{error:s.Z.json({error:"audioUrl must point to a .mp3 or .wav file"},{status:400})};let d={userId:o,imageUrl:r,audioUrl:t,webhookUrl:p,metadata:u&&"object"==typeof u?u:void 0,options:function(e){if(!e||"object"!=typeof e)return;let r="256p"===e.resolution?"256p":"512p",t=sanitizeString(e.enhancer)??null,i=sanitizeString(e.backgroundEnhancer)??null,a=sanitizeString(e.preprocess)??null,o=parseInteger(e.poseStyle),n=parseFloatInRange(e.expressionScale,.1,2),s=parseBoolean(e.still,!1),u=parseInteger(e.batchSize),l=parseIntList(e.inputYaw)??null,p=parseIntList(e.inputPitch)??null,d=parseIntList(e.inputRoll)??null;return{resolution:r,enhancer:t,backgroundEnhancer:i,preprocess:a,poseStyle:o??void 0,expressionScale:n,still:s,batchSize:u??void 0,inputYaw:l,inputPitch:p,inputRoll:d}}(l)};return{payload:d,priority:"number"==typeof e.priority?e.priority:void 0,requestId:e.requestId}}async function handleFormPayload(e){let r=await e.formData(),t=r.get("source_image"),i=r.get("driven_audio");if(!(t instanceof File)||0===t.size)return{error:s.Z.json({error:"source_image file is required"},{status:400})};if(!(i instanceof File)||0===i.size)return{error:s.Z.json({error:"driven_audio file is required"},{status:400})};let a=sanitizeString(r.get("preprocess"))??"full",o=sanitizeString(r.get("enhancer")),n=sanitizeString(r.get("background_enhancer")),u=parseFloatInRange(r.get("expression_scale"),.1,2),l=parseInteger(r.get("pose_style")),p=parseInteger(r.get("batch_size")),d=parseBoolean(r.get("still"),!1),c=parseIntList(r.get("input_yaw"))??null,f=parseIntList(r.get("input_pitch"))??null,g=parseIntList(r.get("input_roll"))??null,m=sanitizeString(r.get("userId")),y=await fileToPayload(t),h=await fileToPayload(i),b={userId:m||"web-client",imageFile:y,audioFile:h,options:{preprocess:a,enhancer:o??null,backgroundEnhancer:n??null,expressionScale:u,poseStyle:l,batchSize:p,still:d,resolution:"256p"===r.get("resolution")?"256p":"512p",inputYaw:c,inputPitch:f,inputRoll:g}},v=sanitizeString(r.get("webhookUrl"));if(v)try{b.webhookUrl=validateUrl(v)}catch(e){return{error:s.Z.json({error:`Invalid webhookUrl: ${e.message}`},{status:400})}}return{payload:b,priority:parseInteger(r.get("priority")),requestId:sanitizeString(r.get("requestId"))}}async function POST(e){try{let r;let t=e.headers.get("content-type")||"";if(t.includes("multipart/form-data"))r=await handleFormPayload(e);else{let t=await e.json().catch(()=>null);r=await handleJsonPayload(t??{})}if(!r||r.error)return r?.error??s.Z.json({error:"Invalid payload"},{status:400});if(!r.payload)return s.Z.json({error:"Payload missing"},{status:400});let i=(0,u.m)(),a=await i.add("generate",r.payload,{priority:r.priority,jobId:r.requestId,attempts:3,backoff:{type:"exponential",delay:1e4}});return s.Z.json({jobId:a.id,state:"queued"},{status:202})}catch(e){return console.error("[sadtalker:create] error",e),s.Z.json({error:"Failed to enqueue SadTalker job"},{status:500})}}let d=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/sadtalker/create/route",pathname:"/api/sadtalker/create",filename:"route",bundlePath:"app/api/sadtalker/create/route"},resolvedPagePath:"/Users/theodorosiakovou/Projects/ai-platform/src/app/api/sadtalker/create/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:c,staticGenerationAsyncStorage:f,serverHooks:g,headerHooks:m,staticGenerationBailout:y}=d,h="/api/sadtalker/create/route"}};var r=require("../../../../webpack-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),t=r.X(0,[2006,550,6277,9701,1051,8605],()=>__webpack_exec__(78250));module.exports=t})();